#!/usr/bin/env node

/**
 * Bundle acorn parser with JSX support into src/parser.js for zero runtime dependencies
 * This creates a self-contained parser module with acorn + acorn-jsx bundled inside
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const projectRoot = path.resolve(__dirname, '..');
const acornPath = path.join(projectRoot, 'node_modules/acorn/dist/acorn.mjs');
const jsxPath = path.join(projectRoot, 'node_modules/acorn-jsx/index.js');
const xhtmlPath = path.join(projectRoot, 'node_modules/acorn-jsx/xhtml.js');
const outputPath = path.join(projectRoot, 'src/parser.js');

console.log('ðŸ“¦ Bundling Acorn parser with JSX support...');
console.log(`   Acorn: ${acornPath}`);
console.log(`   JSX Plugin: ${jsxPath}`);
console.log(`   XHTML Entities: ${xhtmlPath}`);
console.log(`   Output: ${outputPath}`);

// Read source files
let acornSource = fs.readFileSync(acornPath, 'utf8');
let jsxSource = fs.readFileSync(jsxPath, 'utf8');
let xhtmlSource = fs.readFileSync(xhtmlPath, 'utf8');

// Extract XHTML entities - convert module.exports = {...} to just the object
const xhtmlMatch = xhtmlSource.match(/module\.exports\s*=\s*(\{[\s\S]*\});?\s*$/);
if (!xhtmlMatch) {
  throw new Error('Could not parse xhtml.js exports');
}
const xhtmlEntities = xhtmlMatch[1];

// Transform acorn-jsx to ES module compatible code
// 1. Replace require('./xhtml') with inline object
jsxSource = jsxSource.replace(
  /const\s+XHTMLEntities\s*=\s*require\s*\(\s*['"]\.\/xhtml['"]\s*\)\s*;?/,
  `const XHTMLEntities = ${xhtmlEntities};`
);

// 2. Convert module.exports function to named function
// Original: module.exports = function(options) { options = options || {}; return function(Parser) { ... }; };
jsxSource = jsxSource.replace(
  /module\.exports\s*=\s*function\s*\(\s*options\s*\)\s*\{/,
  'function acornJsx(options) {'
);

// 3. Remove the Object.defineProperty for tokTypes (not needed in bundle)
jsxSource = jsxSource.replace(
  /Object\.defineProperty\s*\(\s*module\.exports\s*,\s*["']tokTypes["'][\s\S]*?\}\s*\)\s*;?/,
  '// tokTypes property removed for bundle'
);

// 4. In the plugin function, replace require("acorn") fallback
// Original: const acorn = Parser.acorn || require("acorn");
jsxSource = jsxSource.replace(
  /const\s+acorn\s*=\s*Parser\.acorn\s*\|\|\s*require\s*\(\s*["']acorn["']\s*\)\s*;?/,
  'const acorn = Parser.acorn || { tokTypes: tt, TokContext, TokenType, isNewLine, isIdentifierStart, isIdentifierChar, tokContexts };'
);

// Remove acorn's exports so we can add our own
acornSource = acornSource.replace(
  /export\s*\{[^}]+\}\s*;?\s*$/,
  '// Original exports removed - see bottom of file'
);

// Build the final bundled code
const bundledCode = `/**
 * Self-contained Acorn parser with JSX support (bundled for zero runtime dependencies)
 * Acorn is MIT licensed: https://github.com/acornjs/acorn
 * Acorn-JSX is MIT licensed: https://github.com/acornjs/acorn-jsx
 * This file is auto-generated by scripts/bundle-acorn.js
 */

${acornSource}

// ========== JSX Plugin (acorn-jsx) ==========

${jsxSource}

// ========== Create JSX-enabled Parser ==========

const JSXParser = Parser.extend(acornJsx());

// JSX-aware parse function that replaces the original
function jsxParse(input, options) {
  return JSXParser.parse(input, options);
}

// Alias internal names for external use
const tokTypes = types$1;
const tokContexts = types;

// Export with JSX support - parse now uses JSX-enabled parser
export {
  jsxParse as parse,
  Parser,
  JSXParser,
  tokenizer,
  defaultOptions,
  tokTypes,
  TokContext,
  TokenType,
  isNewLine,
  isIdentifierStart,
  isIdentifierChar,
  tokContexts,
  Node,
  Position,
  SourceLocation,
  Token,
  getLineInfo,
  lineBreak,
  lineBreakG,
  nonASCIIwhitespace,
  parseExpressionAt,
  version
};
`;

// Write bundled file
fs.writeFileSync(outputPath, bundledCode, 'utf8');

const outputSize = (bundledCode.length / 1024).toFixed(1);
console.log(`âœ… Bundled successfully! Output size: ${outputSize}KB`);
console.log('   Zero runtime dependencies achieved!');
console.log('   JSX parsing enabled!');
